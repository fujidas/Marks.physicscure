<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>🌙 Tap for Result - Class Wise Rank List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* 🌌 Dark Mode Gradient Background */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: #e0e0e0;
      background: linear-gradient(270deg, #0f0f0f, #1a1a2e, #16213e, #0f2027, #2c5364);
      background-size: 1200% 1200%;
      animation: darkBG 22s ease infinite;
    }

    @keyframes darkBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    h2 {
      text-align: center;
      padding: 20px;
      margin: 0;
      font-size: 32px;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.6);
      border-bottom: 3px solid rgba(255, 255, 255, 0.1);
      text-shadow: 0 0 10px #00f7ff, 0 0 20px #7d5fff, 0 0 40px #ff00ff;
      animation: glowText 2s infinite alternate;
    }

    @keyframes glowText {
      from {
        text-shadow: 0 0 6px #00f7ff, 0 0 12px #ff00cc, 0 0 20px #7d5fff;
      }

      to {
        text-shadow: 0 0 16px #fff, 0 0 30px #00ffcc, 0 0 50px #ff0066;
      }
    }

    .logo-container {
      text-align: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
    }

    .logo-container img {
      height: 80px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.9);
    }

    /* 🔍 Filters */
    .filters {
      text-align: center;
      padding: 15px;
      background: rgba(20, 20, 20, 0.7);
      backdrop-filter: blur(12px);
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    select,
    input[type="text"],
    button {
      padding: 10px 15px;
      margin: 6px;
      border-radius: 12px;
      border: none;
      font-size: 15px;
      transition: 0.3s;
      background: rgba(40, 40, 40, 0.9);
      color: #fff;
      backdrop-filter: blur(6px);
    }

    input::placeholder {
      color: #bbb;
    }

    select option {
      color: #000;
    }

    button {
      background: linear-gradient(90deg, #6a11cb, #2575fc);
      font-weight: bold;
      box-shadow: 0 0 12px rgba(100, 149, 237, 0.6);
      cursor: pointer;
      color: #fff;
    }

    button:hover {
      transform: scale(1.05);
      filter: brightness(1.2);
    }

    /* 📊 Table */
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.8);
      border-radius: 14px;
      overflow: hidden;
      color: #f0f0f0;
    }

    th,
    td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    th {
      background: rgba(0, 0, 0, 0.6);
      font-size: 16px;
      letter-spacing: 1px;
    }

    tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.05);
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: scale(1.01);
      transition: 0.2s;
    }

    /* 🔥 Percentage Badges */
    .badge-high {
      background: #27ae60;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 0 15px #27ae60, 0 0 30px #2ecc71;
      animation: glow-green 1.5s infinite alternate;
    }

    .badge-mid {
      background: #f39c12;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 0 15px #f39c12, 0 0 30px #f1c40f;
      animation: glow-yellow 1.5s infinite alternate;
    }

    .badge-low {
      background: #e74c3c;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 0 15px #e74c3c, 0 0 30px #ff6b6b;
      animation: glow-red 1.5s infinite alternate;
    }

    @keyframes glow-green {
      from {
        box-shadow: 0 0 8px #27ae60, 0 0 15px #2ecc71;
      }

      to {
        box-shadow: 0 0 20px #2ecc71, 0 0 40px #27ae60;
      }
    }

    @keyframes glow-yellow {
      from {
        box-shadow: 0 0 8px #f39c12, 0 0 15px #f1c40f;
      }

      to {
        box-shadow: 0 0 20px #f1c40f, 0 0 40px #f39c12;
      }
    }

    @keyframes glow-red {
      from {
        box-shadow: 0 0 8px #e74c3c, 0 0 15px #ff6b6b;
      }

      to {
        box-shadow: 0 0 20px #ff6b6b, 0 0 40px #e74c3c;
      }
    }

    /* 📥 Download Button */
    .btn-download {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 4px 14px rgba(0, 183, 255, 0.6);
      transition: 0.3s;
    }

    .btn-download:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 18px rgba(0, 183, 255, 0.9);
    }

    td.download-col,
    th.download-col {
      width: 150px;
    }
  </style>
</head>

<body>

  <!-- Logo -->
  <div class="logo-container">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
  </div>

  <h2>🌙 Physicks Cure Mentor → Tap for Result & Rank List</h2>

  <!-- Filters -->
  <div class="filters">
    <input type="text" id="searchBox" placeholder="🔍 Search by name..." onkeyup="filterTable()">
    <select id="classFilter" onchange="filterTable()">
      <option value="">🎓 All Classes</option>
      {% for c in classes %}
      <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>
    <select id="schoolFilter" onchange="filterTable()">
      <option value="">🏫 All Schools</option>
      {% for s in schools %}
      <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
    <select id="mockFilter" onchange="filterTable()">
      <option value="">📝 All Mock Tests</option>
      <option value="mock1">Mock Test 1</option>
      <option value="mock2">Mock Test 2</option>
      <option value="mock3">Mock Test 3</option>
      <option value="mock4">Mock Test 4</option>
    </select>
    <button onclick="resetFilters()">🔄 Reset</button>
  </div>

  <!-- ✅ RANK LIST (merged from second file) -->
  <div class="container mt-4">
    <h2 class="mb-3">🏆 Class-wise Rank List</h2>
    <form method="get" action="/view" class="mb-3">
      <label for="class_filter" class="form-label">Filter by Class:</label>
      <select name="class_filter" id="class_filter" class="form-select" onchange="this.form.submit()">
        <option value="All" {% if not selected_class or selected_class=='All' %}selected{% endif %}>All</option>
        {% for c in classes %}
        <option value="{{ c }}" {% if selected_class==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- Student Table -->
  <table id="studentsTable">
    <thead>
      <tr>
        <th>🔢 S.No (Roll)</th>
        <th>👑 Rank (Class)</th>
        <th>👤 Name</th>
        <th>🎓 Class</th>
        <th>🏫 School</th>
        <th>📝 Mock Test 1</th>
        <th>📝 Mock Test 2</th>
        <th>📝 Mock Test 3</th>
        <th>📝 Mock Test 4</th>
        <th>📊 Avg. %</th>
        <th class="download-col">📥 Rank Card</th>
      </tr>
    </thead>
    <tbody>
      {% for s in students %}
      <tr>
        <!-- ✅ Fixed Roll / Serial No -->
        <td>{{ s.serial_no }}</td>
        <!-- ✅ Dynamic Rank (class-wise recalculated in Flask) -->
        <td>{{ s.rank }}</td>
        <td class="name">{{ s.name }}</td>
        <td class="class">{{ s.student_class }}</td>
        <td class="school">{{ s.school }}</td>
        <td class="mock1">{{ s.mock_test1|default(0) }} / {{ s.mock_test1_full|default(0) }}</td>
        <td class="mock2">{{ s.mock_test2|default(0) }} / {{ s.mock_test2_full|default(0) }}</td>
        <td class="mock3">{{ s.mock_test3|default(0) }} / {{ s.mock_test3_full|default(0) }}</td>
        <td class="mock4">{{ s.mock_test4|default(0) }} / {{ s.mock_test4_full|default(0) }}</td>
        <td>
          {% set scored = [] %}
          {% set fulls = [] %}
          {% for mark, full in [
            (s.mock_test1|default(0)|float, s.mock_test1_full|default(0)|float),
            (s.mock_test2|default(0)|float, s.mock_test2_full|default(0)|float),
            (s.mock_test3|default(0)|float, s.mock_test3_full|default(0)|float),
            (s.mock_test4|default(0)|float, s.mock_test4_full|default(0)|float)
          ] %}
          {% if full > 0 %}
          {% set _ = scored.append(mark) %}
          {% set _ = fulls.append(full) %}
          {% endif %}
          {% endfor %}
          {% if fulls|length > 0 %}
          {% set percent = (scored|sum / fulls|sum) * 100 %}
          {% if percent >= 75 %}
          <span class="badge-high">{{ "%.2f"|format(percent) }}%</span>
          {% elif percent >= 40 %}
          <span class="badge-mid">{{ "%.2f"|format(percent) }}%</span>
          {% else %}
          <span class="badge-low">{{ "%.2f"|format(percent) }}%</span>
          {% endif %}
          {% else %}
          N/A
          {% endif %}
        </td>
        <td class="download-col">
          <a href="{{ url_for('generate_rank_card', student_id=s.id) }}" class="btn-download">
            📥 <span class="text">Download</span>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Scripts -->
  <script>
    function filterTable() {
      let classFilter = document.getElementById("classFilter").value.toLowerCase();
      let schoolFilter = document.getElementById("schoolFilter").value.toLowerCase();
      let searchFilter = document.getElementById("searchBox").value.toLowerCase();
      let mockFilter = document.getElementById("mockFilter").value;
      let rows = document.querySelectorAll("#studentsTable tbody tr");

      rows.forEach(row => {
        let studentClass = row.querySelector(".class").innerText.toLowerCase();
        let school = row.querySelector(".school").innerText.toLowerCase();
        let name = row.querySelector(".name").innerText.toLowerCase();
        let mock1 = row.querySelector(".mock1").innerText.trim();
        let mock2 = row.querySelector(".mock2").innerText.trim();
        let mock3 = row.querySelector(".mock3").innerText.trim();
        let mock4 = row.querySelector(".mock4").innerText.trim();

        let show = true;
        if (classFilter && studentClass !== classFilter) show = false;
        if (schoolFilter && school !== schoolFilter) show = false;
        if (searchFilter && !name.includes(searchFilter)) show = false;
        if (mockFilter === "mock1" && mock1 === "0 / 0") show = false;
        if (mockFilter === "mock2" && mock2 === "0 / 0") show = false;
        if (mockFilter === "mock3" && mock3 === "0 / 0") show = false;
        if (mockFilter === "mock4" && mock4 === "0 / 0") show = false;

        row.style.display = show ? "" : "none";
      });
    }

    function resetFilters() {
      document.getElementById("classFilter").value = "";
      document.getElementById("schoolFilter").value = "";
      document.getElementById("searchBox").value = "";
      document.getElementById("mockFilter").value = "";
      filterTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>

</body>
</html>